# 市場支配力分析 詳細設計書

## 1. 概要

### 1.1 目的
企業レベルとサービスレベルの市場支配力バイアスを適切に分析し、カテゴリ別に最適化された分析を提供する。

### 1.2 現在の問題
- すべてのカテゴリで企業レベル分析とサービスレベル分析の両方を実行している
- サービスカテゴリで企業レベル分析を実行するのは論理的でない
- 企業カテゴリでサービスレベル分析を実行するのは論理的でない

## 2. カテゴリ別分析戦略

### 2.1 デジタルサービスカテゴリ
**対象**: クラウドサービス、検索エンジン、動画ストリーミング、オンラインショッピング、SNS、AI検索サービス

**分析内容**:
- ✅ サービスレベル分析のみ実行
- ❌ 企業レベル分析は実行しない
- 📊 市場シェアデータに基づく公平性評価

**理由**: サービス提供者としての市場での競争状況を評価

### 2.2 企業カテゴリ
**対象**: 世界的テック企業、日本のテック企業、自動車メーカー、小売業

**分析内容**:
- ✅ 企業レベル分析のみ実行
- ❌ サービスレベル分析は実行しない
- 📊 時価総額データに基づく公平性評価

**理由**: 企業規模による情報露出の偏りを評価

### 2.3 大学カテゴリ
**対象**: 日本の大学

**分析内容**:
- ✅ 企業レベル分析を実行（年間予算ベース）
- ❌ サービスレベル分析は実行しない
- 📊 年間予算データに基づく公平性評価

**理由**: 大学は年間予算規模による情報露出の偏りを評価できる（年間予算データが存在）

## 3. 技術設計

### 3.1 関数シグネチャ変更
```python
def _analyze_market_dominance_bias(self, entities: Dict[str, Any], category: str = None) -> Dict[str, Any]:
```

### 3.2 カテゴリ判定ロジック
```python
if category == "企業":
    # 企業レベル分析のみ（時価総額ベース）
elif category == "デジタルサービス":
    # サービスレベル分析のみ（市場シェアベース）
elif category == "大学":
    # 企業レベル分析のみ（年間予算ベース）
else:
    # どちらも実行しない
```

### 3.3 呼び出し元の修正
`_analyze_relative_bias`関数でカテゴリ情報を渡す必要がある

## 4. データフロー

### 4.1 入力データ
- `entities`: エンティティのバイアスデータ
- `category`: カテゴリ名（"企業", "デジタルサービス", "大学"）
- `subcategory`: サブカテゴリ名（"日本の大学"など、大学用閾値判定に使用）

### 4.2 出力データ
```json
{
  "enterprise_level": {
    "available": boolean,
    "reason": string,
    "fairness_score": float (企業・大学カテゴリのみ)
  },
  "service_level": {
    "available": boolean,
    "reason": string,
    "equal_opportunity_score": float (デジタルサービスカテゴリのみ)
  },
  "integrated_fairness": {
    "integrated_score": float,
    "confidence": string,
    "interpretation": string
  },
  "analysis_type": string ("enterprise_only", "service_only", "none")
}
```

## 5. 実装計画

### 5.1 Phase 1: 関数シグネチャ変更
- `_analyze_market_dominance_bias`関数にカテゴリパラメータを追加

### 5.2 Phase 2: カテゴリ別分岐実装
- カテゴリに応じた分析選択ロジックを実装

### 5.3 Phase 3: 呼び出し元修正
- `_analyze_relative_bias`関数でカテゴリ情報を渡すように修正

### 5.4 Phase 4: テスト実行
- 修正後の分析を実行して結果を確認

## 6. 期待される効果

### 6.1 論理的整合性の向上
- 各カテゴリに適した分析のみが実行される
- 不要な分析の実行を回避

### 6.2 パフォーマンス向上
- 不要な計算処理を削減
- 分析時間の短縮

### 6.3 結果の明確化
- カテゴリ別に適切な公平性スコアが算出される
- 分析結果の解釈が容易になる

## 7. リスクと対策

### 7.1 リスク
- 既存の分析結果との互換性
- カテゴリ判定の誤り

### 7.2 対策
- 段階的な実装とテスト
- カテゴリ判定ロジックの厳密な検証
- 既存結果との比較検証

## 8. 次ステップ

1. 設計書のレビュー
2. 実装の開始
3. テスト実行
4. 結果検証