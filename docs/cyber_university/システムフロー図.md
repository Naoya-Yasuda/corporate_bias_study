# AI検索サービス企業優遇バイアス分析システム フロー図

## システム全体フロー図

```mermaid
flowchart TD
    A[研究開始] --> B[設定ファイル読み込み<br/>analysis_config.yml]
    B --> C[データ収集フェーズ]

    subgraph "データ収集フェーズ"
        C --> D[Perplexity感情分析<br/>企業名マスキング vs 実名]
        C --> E[Perplexityランキング<br/>カテゴリ別推薦順位]
        C --> F[Perplexity引用リンク<br/>情報源URL・説明文]
        C --> G[Google検索結果<br/>従来型検索データ]

        D --> H[データ品質チェック<br/>異常値・欠損値検出]
        E --> H
        F --> H
        G --> H

        H --> I[データ統合・正規化<br/>統一フォーマット変換]
    end

    subgraph "分析処理フェーズ"
        I --> J[バイアス分析エンジン<br/>BiasAnalysisEngine]

        J --> K[感情分析処理<br/>Raw Delta, NBI計算]
        J --> L[ランキング分析処理<br/>順位相関・安定性]
        J --> M[比較分析処理<br/>プラットフォーム間比較]
        J --> N[市場集中度分析<br/>HHI計算]
        J --> O[公平性評価処理<br/>企業・サービスレベル]

        K --> P[統計的有意性検定<br/>符号検定・効果量]
        L --> P
        M --> P
        N --> P
        O --> P

        P --> Q[包括的バイアス指標<br/>統合評価結果]
    end

    subgraph "可視化・出力フェーズ"
        Q --> R[分析結果保存<br/>JSON形式]
        R --> S[ダッシュボード生成<br/>Streamlit Web App]

        S --> T[感情スコア可視化<br/>NBI棒グラフ]
        S --> U[ランキング分析可視化<br/>相関散布図]
        S --> V[検索結果比較可視化<br/>プラットフォーム比較]
        S --> W[統合分析可視化<br/>公平性スコア]
        S --> X[時系列分析可視化<br/>トレンドグラフ]

        T --> Y[研究結果出力<br/>論文・レポート]
        U --> Y
        V --> Y
        W --> Y
        X --> Y
    end

    Y --> Z[研究完了]
```

## データ収集詳細フロー図

```mermaid
flowchart TD
    A[データ収集開始] --> B[設定ファイル読み込み]
    B --> C[対象企業・サービスリスト取得]
    C --> D[実行回数設定<br/>デフォルト15回]

    subgraph "第1段階: Perplexity感情分析"
        D --> E[企業名マスキング質問生成]
        E --> F[企業名実名質問生成]
        F --> G[Perplexity API呼び出し<br/>sonarモデル使用]
        G --> H[10点満点感情スコア取得]
        H --> I[感情スコアデータ保存]
    end

    subgraph "第2段階: Perplexityランキング"
        I --> J[カテゴリ別推薦クエリ生成]
        J --> K[Perplexity API呼び出し]
        K --> L[企業・サービス推薦順位取得]
        L --> M[ランキングデータ保存]
    end

    subgraph "第3段階: Perplexity引用リンク"
        M --> N[引用リンクデータ収集]
        N --> O[URL・説明文抽出]
        O --> P[引用リンクデータ保存]
    end

    subgraph "第4段階: Google検索データ"
        P --> Q[Google Custom Search API呼び出し]
        Q --> R[検索結果データ取得]
        R --> S[Google検索データ保存]
    end

    subgraph "第5段階: 引用データ感情分析"
        S --> T[引用リンクデータ読み込み]
        T --> U[Perplexity API感情分析]
        U --> V[引用データ感情スコア保存]
    end

    subgraph "第6段階: Googleデータ感情分析"
        V --> W[Google検索データ読み込み]
        W --> X[Perplexity API感情分析]
        X --> Y[Googleデータ感情スコア保存]
    end

    subgraph "第7段階: データ統合"
        Y --> Z[全データセット統合]
        Z --> AA[データ正規化処理]
        AA --> BB[統合データセット保存<br/>corporate_bias_dataset.json]
    end

    subgraph "第8段階: データ品質管理"
        BB --> CC[異常値検出]
        CC --> DD[欠損値処理]
        DD --> EE[重複データ除去]
        EE --> FF[データ品質レポート生成]
    end

    FF --> GG[データ収集完了]
```

## バイアス分析処理フロー図

```mermaid
flowchart TD
    A[分析開始] --> B[統合データセット読み込み]
    B --> C[データ検証<br/>必須フィールドチェック]
    C --> D[実行回数確認<br/>統計的有意性判定]

    subgraph "感情分析処理"
        D --> E[企業別感情スコア抽出]
        E --> F[マスキング vs 実名比較]
        F --> G[Raw Delta計算<br/>Δ = unmasked - masked]
        G --> H[カテゴリ内正規化<br/>NBI = Δ / 平均|Δ|]
        H --> I[統計的有意性検定<br/>符号検定]
        I --> J[効果量測定<br/>Cliff's Delta]
        J --> K[信頼区間計算<br/>Bootstrap法]
    end

    subgraph "ランキング分析処理"
        K --> L[ランキングデータ抽出]
        L --> M[平均順位計算]
        M --> N[順位相関分析<br/>Pearson・Spearman]
        N --> O[ランキング安定性評価<br/>標準偏差正規化]
        O --> P[ランキング品質評価<br/>一貫性チェック]
    end

    subgraph "比較分析処理"
        P --> Q[プラットフォーム間比較]
        Q --> R[Kendall's Tau計算<br/>順位相関]
        R --> S[RBO計算<br/>Rank Biased Overlap]
        S --> T[重複サイト数分析]
        T --> U[公式・非公式ドメイン比率]
        U --> V[感情比率比較<br/>ポジ・ネガ・ニュートラル]
    end

    subgraph "市場集中度分析"
        V --> W[市場シェアデータ読み込み]
        W --> X[HHI計算<br/>Σ(シェア%)²]
        X --> Y[市場構造分類<br/>集中度判定]
        Y --> Z[企業規模別分類<br/>時価総額基準]
    end

    subgraph "公平性評価処理"
        Z --> AA[企業レベル公平性スコア]
        AA --> BB[サービスレベル公平性スコア]
        BB --> CC[統合公平性評価]
        CC --> DD[バイアス重篤度スコア]
    end

    DD --> EE[分析結果統合]
    EE --> FF[包括的バイアス指標生成]
    FF --> GG[分析完了]
```

## ダッシュボード表示フロー図

```mermaid
flowchart TD
    A[ダッシュボード起動] --> B[Streamlit Web App初期化]
    B --> C[サイドバー表示<br/>分析条件選択]

    C --> D[分析日付選択]
    C --> E[カテゴリ選択]
    C --> F[可視化タイプ選択]

    subgraph "データ取得処理"
        D --> G[HybridDataLoader初期化]
        E --> G
        F --> G
        G --> H[キャッシュチェック<br/>TTL=3600秒]
        H --> I{キャッシュヒット?}
        I -->|Yes| J[キャッシュデータ使用]
        I -->|No| K[データソース判定<br/>S3/Local]
        K --> L[データ読み込み]
        L --> M[データ前処理]
        M --> N[キャッシュ保存]
        N --> J
    end

    subgraph "可視化処理"
        J --> O[可視化タイプ判定]

        O -->|感情スコア分析| P[NBI棒グラフ生成<br/>Plotly]
        O -->|ランキング分析| Q[相関散布図生成<br/>Plotly]
        O -->|検索結果比較| R[プラットフォーム比較<br/>Plotly]
        O -->|統合分析| S[公平性スコア<br/>Plotly]
        O -->|時系列分析| T[トレンドグラフ<br/>Plotly]

        P --> U[グラフ表示]
        Q --> U
        R --> U
        S --> U
        T --> U
    end

    subgraph "インタラクティブ機能"
        U --> V[フィルタリング機能]
        V --> W[ソート機能]
        W --> X[ドリルダウン機能]
        X --> Y[エクスポート機能<br/>PNG/SVG/PDF]
    end

    Y --> Z[ダッシュボード表示完了]
```

## 統計的検証フロー図

```mermaid
flowchart TD
    A[統計的検証開始] --> B[データ品質チェック]
    B --> C[実行回数確認<br/>最小要件チェック]

    subgraph "信頼性評価"
        C --> D[信頼性レベル判定]
        D --> E{実行回数}
        E -->|< 2回| F[実行不足<br/>分析不可]
        E -->|2回| G[参考程度<br/>基本分析]
        E -->|3-4回| H[基本分析<br/>実用分析]
        E -->|5-9回| I[実用分析<br/>標準分析]
        E -->|10-19回| J[標準分析<br/>高精度分析]
        E -->|20回以上| K[高精度分析<br/>研究レベル]
    end

    subgraph "統計的有意性検定"
        F --> L[符号検定実行]
        G --> L
        H --> L
        I --> L
        J --> L
        K --> L

        L --> M[p値計算]
        M --> N{有意性判定<br/>p < 0.05}
        N -->|Yes| O[統計的有意<br/>結果採用]
        N -->|No| P[統計的非有意<br/>結果保留]
    end

    subgraph "効果量測定"
        O --> Q[Cliff's Delta計算]
        P --> Q
        Q --> R{効果量判定}
        R -->|< 0.147| S[効果量小<br/>実践的意義低]
        R -->|0.147-0.33| T[効果量中<br/>実践的意義中]
        R -->|0.33-0.474| U[効果量大<br/>実践的意義高]
        R -->|> 0.474| V[効果量非常大<br/>実践的意義極高]
    end

    subgraph "多重比較補正"
        S --> W[FDR-BH法適用]
        T --> W
        U --> W
        V --> W

        W --> X[補正後p値計算]
        X --> Y{補正後有意性}
        Y -->|Yes| Z[補正後有意<br/>結果確定]
        Y -->|No| AA[補正後非有意<br/>結果棄却]
    end

    subgraph "信頼区間計算"
        Z --> BB[Bootstrap法実行<br/>10,000回反復]
        AA --> BB
        BB --> CC[95%信頼区間計算]
        CC --> DD[信頼区間解釈]
    end

    DD --> EE[統計的検証完了]
```

## エラーハンドリング・品質管理フロー図

```mermaid
flowchart TD
    A[処理開始] --> B[初期化チェック]
    B --> C{設定ファイル存在?}
    C -->|No| D[設定ファイルエラー<br/>処理停止]
    C -->|Yes| E[API認証チェック]

    E --> F{API認証成功?}
    F -->|No| G[認証エラー<br/>APIキー確認]
    F -->|Yes| H[データ収集開始]

    subgraph "データ収集エラーハンドリング"
        H --> I[Perplexity API呼び出し]
        I --> J{API呼び出し成功?}
        J -->|No| K[レート制限確認<br/>待機処理]
        J -->|Yes| L[データ保存]

        K --> M{待機時間経過?}
        M -->|No| K
        M -->|Yes| I

        L --> N[Google API呼び出し]
        N --> O{API呼び出し成功?}
        O -->|No| P[ネットワークエラー<br/>再試行]
        O -->|Yes| Q[データ保存]

        P --> R{再試行回数 < 3?}
        R -->|Yes| N
        R -->|No| S[永続的エラー<br/>処理停止]
    end

    subgraph "データ品質管理"
        Q --> T[データ検証]
        T --> U{必須フィールド存在?}
        U -->|No| V[データ不完全<br/>警告出力]
        U -->|Yes| W[異常値検出]

        W --> X{異常値発見?}
        X -->|Yes| Y[異常値処理<br/>除外/補完]
        X -->|No| Z[欠損値チェック]

        Y --> Z
        Z --> AA{欠損値存在?}
        AA -->|Yes| BB[欠損値処理<br/>補完/除外]
        AA -->|No| CC[重複データチェック]

        BB --> CC
        CC --> DD{重複データ存在?}
        DD -->|Yes| EE[重複データ除去]
        DD -->|No| FF[データ品質OK]

        EE --> FF
    end

    subgraph "分析処理エラーハンドリング"
        FF --> GG[バイアス分析開始]
        GG --> HH{データ形式正規?}
        HH -->|No| II[データ形式エラー<br/>前処理実行]
        HH -->|Yes| JJ[統計計算実行]

        II --> JJ
        JJ --> KK{計算成功?}
        KK -->|No| LL[計算エラー<br/>ログ出力]
        KK -->|Yes| MM[結果保存]

        LL --> NN{エラー回復可能?}
        NN -->|Yes| JJ
        NN -->|No| OO[分析失敗<br/>部分結果保存]
    end

    subgraph "可視化エラーハンドリング"
        MM --> PP[可視化処理開始]
        OO --> PP
        PP --> QQ{データ存在?}
        QQ -->|No| RR[データ不足<br/>エラーメッセージ]
        QQ -->|Yes| SS[グラフ生成]

        SS --> TT{グラフ生成成功?}
        TT -->|No| UU[可視化エラー<br/>代替表示]
        TT -->|Yes| VV[ダッシュボード表示]

        UU --> VV
    end

    VV --> WW[処理完了]
```

## システム運用・監視フロー図

```mermaid
flowchart TD
    A[システム運用開始] --> B[GitHub Actions<br/>スケジュール実行]
    B --> C[毎週月曜日<br/>午前6時（JST）]

    subgraph "自動実行監視"
        C --> D[ワークフロー開始]
        D --> E[環境チェック<br/>Python・依存関係]
        E --> F{環境正常?}
        F -->|No| G[環境エラー<br/>通知送信]
        F -->|Yes| H[データ収集実行]

        H --> I[実行状況監視]
        I --> J{実行成功?}
        J -->|No| K[実行エラー<br/>ログ記録]
        J -->|Yes| L[分析処理実行]

        K --> M{エラー回復可能?}
        M -->|Yes| H
        M -->|No| N[永続的エラー<br/>管理者通知]
    end

    subgraph "データ品質監視"
        L --> O[データ品質チェック]
        O --> P{品質基準満足?}
        P -->|No| Q[品質警告<br/>詳細分析]
        P -->|Yes| R[分析結果保存]

        Q --> S{品質問題重大?}
        S -->|Yes| T[品質エラー<br/>処理停止]
        S -->|No| R
    end

    subgraph "パフォーマンス監視"
        R --> U[実行時間測定]
        U --> V{実行時間正常?}
        V -->|No| W[パフォーマンス警告<br/>最適化提案]
        V -->|Yes| X[リソース使用量チェック]

        W --> X
        X --> Y{リソース使用量正常?}
        Y -->|No| Z[リソース警告<br/>スケール調整]
        Y -->|Yes| AA[結果通知送信]

        Z --> AA
    end

    subgraph "継続的改善"
        AA --> BB[実行結果ログ記録]
        BB --> CC[パフォーマンス分析]
        CC --> DD[改善点特定]
        DD --> EE[設定調整<br/>最適化]
        EE --> FF[次回実行準備]
    end

    FF --> GG[運用サイクル完了]
    GG --> C
```

---

*図6: システム全体フロー図*

*図7: 8段階データ収集詳細フロー*

*図8: バイアス分析処理フロー*

*図9: ダッシュボード表示フロー*

*図10: 統計的検証フロー*

*図11: エラーハンドリング・品質管理フロー*

*図12: システム運用・監視フロー*