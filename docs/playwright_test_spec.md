# Playwright自動UIテスト仕様書

## 【重要】テスト実行方針
- 本テストはローカルでテストコードを書くのではなく、**MCP（Managed Cloud Platform）上でPlaywrightの対話機能（AIチャット経由のブラウザ自動操作）を使って、UIを本当に自動テストする運用**とする。
- ローカルでのテストコード実装・管理は原則行わず、MCP上での自動化・証跡取得・検証を前提とする。
- 今後、テスト実施・検証・証跡取得はMCP環境で統一し、AIチャット経由のPlaywright自動操作によるE2E検証が標準となる。

## 前提条件（必須）
- **テスト実施前に必ず以下のキャッシュクリアを行うこと**
    - Streamlitアプリのキャッシュをクリアする（再起動は不要、`st.cache_data.clear()`等を実行）
    - ブラウザのキャッシュをクリアし、ページをリロードする
    - ポート競合や古いプロセスが残っていないことを確認
- 上記を徹底しない場合、古いUIやキャッシュが表示され、実データ一致検証が正しく行えない可能性がある

---

## テスト手順（抜粋）

1. **環境リフレッシュ**
    - Streamlitアプリのキャッシュをクリアする（再起動は不要、`st.cache_data.clear()`等を実行）
    - ブラウザのキャッシュをクリアし、ページをリロードする
2. UIにアクセスし、サイドバー・表・プロンプト内容がデータセット内容（AWS, Azure等）と完全一致していることを確認
3. ...（以降、既存のテスト手順）

---

## 1. テスト対象
- `app.py`（Streamlitダッシュボード 単日分析画面）

## 2. 前提条件
- テスト用データ（corporate_bias_dataset.json等）が正しく配置されている
- Streamlitアプリがローカルまたはテスト環境で起動済み
- Playwrightのセットアップ・依存パッケージインストール済み
- **Chromeブラウザのみでテストを実施**

---

## 3. テストケース一覧

### 3.1 サイドバーUIの動作・連動確認

| No  | テスト内容               | 操作手順                                                                              | 期待結果                                           |
| --- | ------------------------ | ------------------------------------------------------------------------------------- | -------------------------------------------------- |
| 1   | 可視化タイプ選択肢の表示 | サイドバーを開く                                                                      | 「単日分析」「時系列分析」の選択肢が表示されている |
| 2   | 単日分析選択時の日付選択 | 「単日分析」を選択し、日付ドロップダウンを開く                                        | 利用可能な日付リストが表示される                   |
| 3   | 分析タイプ切り替えUI     | 「感情スコア」「ランキング」「Google検索 vs Citations比較」のラジオボタンが表示される | 3つの分析タイプが選択可能                          |

---

### 3.2 サイドバー操作によるデータ・グラフ内容の動的変化

| No  | テスト内容                             | 操作手順                                                                          | 期待結果                                                                                                                                 |
| --- | -------------------------------------- | --------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| 4   | 日付選択によるデータ・グラフの切替     | サイドバーで異なる日付を選択                                                      | メイン画面のデータプレビュー表・グラフ・詳細内容が選択日付に応じて変化する                                                               |
| 5   | 分析タイプ切替によるグラフ・詳細の切替 | サイドバーで「感情スコア」「ランキング」「Google検索 vs Citations比較」を順に選択 | それぞれに対応したグラフ・詳細展開が正しく切り替わる（例：感情スコア平均の棒グラフ→ランキング平均の棒グラフ→Google/Citations比較リスト） |
| 6   | プロンプト内容の切替                   | 分析タイプを切り替え、プロンプトexpanderを開く                                    | 選択した分析タイプに対応するプロンプト文が表示される（内容が切り替わる）                                                                 |

---

### 3.3 データプレビュー・詳細展開

| No  | テスト内容               | 操作手順                           | 期待結果                                                                                                                    |
| --- | ------------------------ | ---------------------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| 7   | データプレビュー表の表示 | 画面を開く                         | カテゴリ・サブカテゴリ・エンティティ・感情スコア平均・ランキング平均・公式URL率のカラムが表示される（実行回数カラムは無い） |
| 8   | 詳細expanderの動作       | 任意のエンティティのexpanderを開く | 感情スコア配列・ランキング配列・Google/Citations結果が正しく表示される                                                      |

---

### 3.4 その他UI/UX

| No  | テスト内容                     | 操作手順                   | 期待結果                                     |
| --- | ------------------------------ | -------------------------- | -------------------------------------------- |
| 9   | レイアウト崩れの有無           | 画面幅を変更               | レイアウトが崩れず、横スクロール等で閲覧可能 |
| 10  | 情報量が多い場合のexpander動作 | 表や詳細expanderを複数開閉 | UXが損なわれず、情報が正しく表示される       |

---

### 3.5 追加観点

#### 4. レスポンシブ/画面幅
| No  | テスト内容                  | 操作手順                                   | 期待結果                                                           |
| --- | --------------------------- | ------------------------------------------ | ------------------------------------------------------------------ |
| 11  | 画面幅を狭めた場合のUI崩れ  | ブラウザ幅を極端に狭くする                 | 主要UI（サイドバー・表・グラフ）が崩れず、横スクロール等で閲覧可能 |
| 12  | スマホ/タブレット幅での表示 | ブラウザの幅をスマホ・タブレット相当に変更 | 主要UIが正しく表示され、操作可能                                   |

#### 5. 国際化/日本語表示
| No  | テスト内容             | 操作手順       | 期待結果                                                         |
| --- | ---------------------- | -------------- | ---------------------------------------------------------------- |
| 13  | UIの日本語表示         | 画面全体を確認 | すべてのUI要素が日本語で表示されている（文字化けや英語UIがない） |
| 14  | フォント・文字化け確認 | 画面全体を確認 | 日本語フォントが正しく表示され、文字化けがない                   |

#### 6. ダウンロード・エクスポート
| No  | テスト内容                     | 操作手順                               | 期待結果                               |
| --- | ------------------------------ | -------------------------------------- | -------------------------------------- |
| 15  | データダウンロードボタンの動作 | ダウンロードボタンがあればクリック     | 正しいファイルがダウンロードされる     |
| 16  | 画像ダウンロードボタンの動作   | 画像ダウンロードボタンがあればクリック | 画像ファイルが正常にダウンロードされる |

#### 7. 初期表示・デフォルト値
| No  | テスト内容                     | 操作手順                     | 期待結果                                                             |
| --- | ------------------------------ | ---------------------------- | -------------------------------------------------------------------- |
| 17  | 初回アクセス時のデフォルト選択 | アプリに初回アクセス         | サイドバー・分析タイプ・日付等が意図したデフォルト値で表示されている |
| 18  | デフォルト表示内容の確認       | 初回アクセス直後の画面を確認 | データプレビュー表・グラフ・プロンプト等が正しく初期表示されている   |

---

## 4. テストデータ例
- corporate_bias_dataset.json（エンティティ数・サブカテゴリ数が複数あるもの）
- 各エンティティに感情スコア・ランキング・official_results・reputation_resultsが含まれていること

---

## 5. 備考
- **Chromeのみでテストを実施**
- 画面キャプチャ・エラー時のログ取得も行う
- 必要に応じてアクセシビリティやレスポンシブ動作も確認
- **Streamlitアプリの再起動は不要。キャッシュクリア（`st.cache_data.clear()`等）のみ必須。**
- **Playwrightテストはローカルでテストコードを書くのではなく、MCP（Managed Cloud Platform）上で自動実行・検証する運用とする。今後はMCPでの自動化・検証・証跡取得を前提とすること。**
- **本テストはMCP（Managed Cloud Platform）上でPlaywrightの対話機能（AIチャット経由のブラウザ自動操作）を使って、UIを本当に自動テストする運用**とする。
- **今後、テスト実施・検証・証跡取得はMCP環境で統一し、AIチャット経由のPlaywright自動操作によるE2E検証が標準となる。**

## 追加テストケース

### 1. プロンプト表示の検証
- サイドバーでカテゴリ・サブカテゴリ・エンティティを選択
- 画面上部の「プロンプト（クエリ/AIプロンプト文）」expanderを展開
- データセットの official_answer, reputation_answer などが正しく表示されていること
- サンプル文やハードコーディングではなく、実データが反映されていること

### 2. 表のカラム名・データ一致検証
- 分析タイプごとに表示される表のカラム名が仕様通りであること
    - 感情スコア: エンティティ, 感情スコア平均, 実行回数, BI値
    - ランキング: エンティティ, ランキング平均, 実行回数
    - Google vs Citations比較: エンティティ, Google公式URL率, Citations公式URL率, RBOスコア, Kendall Tau, Overlap Ratio
- 表示されるデータがカラム名と正確に対応していること
- 不要なカラムやデータが混在していないこと

### 3. エンティティ・表・プロンプト内容の実データ一致検証
- サイドバーでカテゴリ・サブカテゴリ・エンティティ（例：AWS, Azure等）を選択
- 表の「エンティティ」列や数値カラムがデータセット（corporate_bias_dataset.json）の内容と完全一致していること
- プロンプト（official_answer, reputation_answer等）もデータセット内容と一致していること
- サンプルやハードコーディングではなく、実データがそのまま反映されていること
- UI上で目視または自動テストで検証し、証拠を残すこと