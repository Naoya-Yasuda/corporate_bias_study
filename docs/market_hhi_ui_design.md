# 市場データHHI分析 UI表示設計書（修正版）

## 1. 概要

### 1.1 目的
統合分析結果において、市場集中度分析（HHI）の結果を効果的に表示し、ユーザーが市場構造とバイアスの関係性を理解できるUIを提供する。

### 1.2 表示対象
- サービスレベルHHI分析結果
- 企業レベルHHI分析結果
- 集中度-バイアス相関分析
- 市場構造インサイト

## 2. 現在の画面構成と統合方針

### 2.1 既存の3タブ構成
```
統合分析結果
├── サブカテゴリ分析
├── 全体統合分析
└── 市場分析 ← ここに統合
```

### 2.2 統合方針
**市場分析タブ内に「市場集中度分析」セクションを新規追加**

既存の市場分析タブには以下が含まれている：
- 市場支配・公平性分析（market_dominance_analysis）

新規追加する市場集中度分析は、既存の市場支配・公平性分析と並列で表示し、相互補完的な分析として機能させる。

## 3. 市場分析タブ内の構成

### 3.1 全体構成
```
市場分析タブ
├── 市場支配・公平性分析（既存）
│   ├── 企業レベル公平性スコア
│   ├── サービスレベル公平性スコア
│   └── 補助指標
└── 市場集中度分析（新規追加）
    ├── 概要メトリクス
    ├── サービスレベルHHI
    ├── 企業レベルHHI
    ├── 集中度-バイアス相関
    └── 市場構造インサイト
```

### 3.2 セクション間の関係性
- **市場支配・公平性分析**: バイアス指標と市場シェアの公平性評価
- **市場集中度分析**: 市場構造の集中度とバイアスリスクの相関分析

## 4. 詳細UI設計

### 4.1 市場集中度分析セクション

#### 4.1.1 セクションヘッダー
```python
st.markdown("---")  # 既存セクションとの区切り
st.subheader("📊 市場集中度分析")
st.caption("市場構造の集中度とバイアスリスクの関係性を分析します")
```

#### 4.1.2 概要メトリクスカード
```
┌─────────────────────────────────────────────────────────┐
│ 📊 市場集中度分析概要                                    │
├─────────────────────────────────────────────────────────┤
│ サービス市場集中度: 高集中市場 (HHI: 2,847)             │
│ 企業市場集中度: 高集中市場 (HHI: 3,125)                 │
│ バイアス相関強度: 強い正の相関 (r=0.73)                 │
│ 市場構造リスク: 高リスク                                 │
└─────────────────────────────────────────────────────────┘
```

**実装要素:**
- 4つのメトリクスをカード形式で表示
- リスクレベルに応じた色分け
- 簡潔な要約テキスト

### 4.2 サービスレベルHHIセクション

#### 4.2.1 レイアウト
```
┌─────────────────────────────────────────────────────────┐
│ 🏢 サービス市場集中度分析                                │
├─────────────────────────────────────────────────────────┤
│ HHI値: 2,847.3 (高集中市場)                             │
│ 市場構造: 寡占市場                                       │
│ 上位サービス:                                            │
│ • Service A: 45.2% (1位)                               │
│ • Service B: 28.7% (2位)                               │
│ • Service C: 15.3% (3位)                               │
│                                                         │
│ 公平性への影響: 市場集中により特定サービスへのバイアス   │
│ リスクが高い                                            │
└─────────────────────────────────────────────────────────┘
```

**実装要素:**
- HHI値の大きな数値表示
- 集中度レベルの色分け表示
- 上位サービスランキング
- 影響分析テキスト

### 4.3 企業レベルHHIセクション

#### 4.3.1 レイアウト
```
┌─────────────────────────────────────────────────────────┐
│ 🏭 企業市場集中度分析                                    │
├─────────────────────────────────────────────────────────┤
│ HHI値: 3,124.8 (高集中市場)                             │
│ 企業規模別シェア:                                        │
│ • 大企業: 68.5%                                         │
│ • 中企業: 24.3%                                         │
│ • 小企業: 7.2%                                          │
│                                                         │
│ 市場支配力分析: 大企業による市場支配力が強い             │
│ バイアスリスク評価: 企業規模によるバイアスが顕著         │
└─────────────────────────────────────────────────────────┘
```

**実装要素:**
- 企業規模別円グラフ
- 支配力分析テキスト
- リスク評価の色分け

### 4.4 集中度-バイアス相関セクション

#### 4.4.1 レイアウト
```
┌─────────────────────────────────────────────────────────┐
│ 📈 集中度-バイアス相関分析                               │
├─────────────────────────────────────────────────────────┤
│ サービスHHI-バイアス相関: 0.73 (強い正の相関)           │
│ 企業HHI-バイアス相関: 0.68 (強い正の相関)               │
│                                                         │
│ 相関解釈: 市場集中度が高いほどバイアスが強くなる傾向     │
│                                                         │
│ 集中度レベル別分析:                                      │
│ • 高集中市場: バイアス強度 0.85                          │
│ • 中程度集中市場: バイアス強度 0.52                      │
│ • 非集中市場: バイアス強度 0.31                          │
└─────────────────────────────────────────────────────────┘
```

**実装要素:**
- 相関係数の数値表示
- 解釈テキスト
- レベル別分析テーブル

### 4.5 市場構造インサイトセクション

#### 4.5.1 レイアウト
```
┌─────────────────────────────────────────────────────────┐
│ 💡 市場構造インサイト                                    │
├─────────────────────────────────────────────────────────┤
│ • 寡占市場構造により競争制限的なバイアスが発生           │
│ • 大企業の市場支配力が検索結果の偏りを助長               │
│ • 市場集中度の低下によりバイアス軽減が期待される         │
│ • 上位企業への過度な露出が公平性を損なう可能性           │
│ • 市場構造の改善がバイアス軽減の鍵となる                 │
└─────────────────────────────────────────────────────────┘
```

**実装要素:**
- インサイトリスト（箇条書き）
- 重要度アイコン
- アクショナブルな改善提案

## 5. 実装詳細

### 5.1 データ取得
```python
def get_market_concentration_data(analysis_data):
    """
    市場集中度分析データを取得
    """
    relative_bias = analysis_data.get("relative_bias_analysis", {})
    market_concentration = relative_bias.get("market_concentration_analysis", {})
    return market_concentration
```

### 5.2 レンダリング関数
```python
def render_market_concentration_analysis(analysis_data, selected_category, selected_subcategory):
    """
    市場集中度分析セクションのレンダリング
    """
    # データ取得
    market_concentration = get_market_concentration_data(analysis_data)

    if not market_concentration:
        st.info("市場集中度分析データがありません")
        return

    # セクションヘッダー
    st.markdown("---")
    st.subheader("📊 市場集中度分析")
    st.caption("市場構造の集中度とバイアスリスクの関係性を分析します")

    # 概要メトリクス
    render_summary_metrics(market_concentration)

    # サービスレベルHHI
    render_service_hhi(market_concentration)

    # 企業レベルHHI
    render_enterprise_hhi(market_concentration)

    # 相関分析
    render_concentration_correlation(market_concentration)

    # インサイト
    render_market_insights(market_concentration)
```

### 5.3 既存コードへの統合
```python
# 市場分析タブ内（app.py line 1789付近）
with main_tabs[2]:
    # === 市場支配・公平性分析（既存） ===
    st.subheader("🏢 市場支配・公平性分析")
    # ... 既存の市場支配・公平性分析コード ...

    # === 市場集中度分析（新規追加） ===
    render_market_concentration_analysis(analysis_data, selected_category, selected_subcategory)
```

## 6. エラーハンドリング

### 6.1 データ不足時の対応
- 市場集中度分析データが存在しない場合の適切なメッセージ表示
- 部分的なデータ不足時のフォールバック表示

### 6.2 計算エラー時の対応
- HHI計算時のゼロ除算エラー回避
- 相関計算時のデータ不整合対応

## 7. レスポンシブ対応

### 7.1 デスクトップ表示
- 2カラムレイアウトで効率的な情報表示
- 詳細なグラフとテーブル表示

### 7.2 モバイル表示
- 1カラムレイアウト
- 簡潔な数値表示
- スクロール優先の情報配置

## 8. 実装優先順位

### 8.1 Phase 1 (基本表示)
- 概要メトリクスセクション
- サービスレベルHHI表示
- 企業レベルHHI表示

### 8.2 Phase 2 (詳細機能)
- 集中度-バイアス相関分析
- 市場構造インサイト
- エラーハンドリング

### 8.3 Phase 3 (高度機能)
- 可視化グラフ
- インタラクティブ要素
- レスポンシブ対応

---

**作成日**: 2025年1月27日
**作成者**: AI Assistant
**バージョン**: 2.0（修正版）