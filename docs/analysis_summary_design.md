---
title: 企業バイアス分析ダッシュボード「分析サマリー」設計書
date: {dynamic_date}
type: "rule"
alwaysApply: true
globs: ["**/*"]
---

# 企業バイアス分析ダッシュボード「分析サマリー」設計書

## 1. 目的・背景
- 企業バイアス分析ダッシュボードにおいて、膨大な分析データから主要な傾向や注目点を一目で把握できる「分析サマリー」機能を新設する。
- これにより、ユーザーは個別データの詳細分析に加え、全体傾向や異常値、注目カテゴリを迅速に把握可能となる。
- また、Google SERP表記を「Google Custom Search」に統一し、比較指標の明確化・UI/コメントの一貫性を図る。

## 2. 新機能概要
- サイドバーまたはトップに「分析サマリー」タブ/セクションを追加。
- 最新データや全データから主要指標（バイアス指標、ランキング類似度、公式/非公式比率等）を自動抽出し、グラフ・表・テキストで表示。
- 異常値や大きな変動を自動検出し、注目点として強調表示。
- Google Custom SearchとPerplexityの比較指標もサマリー内で可視化。

## 3. データ構造・取得方法
- corporate_bias_datasets/integrated/配下の日付ディレクトリ（例: 20250702, 20250624 など）から最新のJSON/CSVデータを取得。
- データは「カテゴリ→サブカテゴリ→サービス/指標」等の多層構造。
- ファイル名・ディレクトリ名から日付・データタイプ・カテゴリ等を判別。
- 主要な分析ファイルは bias_analysis_results.json, corporate_bias_dataset.json など。
- S3やresults/配下の参照は廃止し、integrated配下のみを利用する。
- サマリー・詳細分析・画像指標の各セクションはintegrated配下のデータ構造・命名規則に準拠する。

## 4. 主要指標一覧
- バイアス指標（カテゴリ別・サービス別）
- 感情スコア（平均・分布・変動）
- ランキング類似度（RBO, Kendall Tau, Overlap Ratio等）
- 公式/非公式比率、ポジ/ネガ比率
- データ件数・カバレッジ状況
- 異常値・大きな変動（自動抽出）

## 5. UI設計
- サイドバーまたはトップに「分析サマリー」タブ/ページを追加
- サマリー内で主要指標をグラフ・表・テキストで表示
- 異常値や注目点は色やアイコンで強調
- 「詳細を見る」ボタンから該当カテゴリ・サービスの詳細分析にジャンプ
- Google Custom Search/Perplexity比較もサマリー内で可視化

## 6. 内部処理フロー
1. S3から最新データファイルを取得
2. 各カテゴリ・サービスごとに主要指標を抽出
3. 必要に応じて過去データと比較し、変動や傾向を算出
4. 異常値や注目点を自動抽出（閾値・統計的手法等）
5. サマリー用データを整形し、UIに渡す

## 7. Google Custom Search対応
- 旧「Google SERP」表記はすべて「Google Custom Search」に統一
- コード・UI・コメント・変数名等も一貫して修正
- Google Custom Search APIから取得したデータをPerplexityデータと同様に扱い、比較指標を算出

## 8. 今後の拡張方針
- サマリー指標の拡充（例：時系列変化の自動検出、AIによる注目点要約等）
- ユーザーごとのカスタマイズサマリー
- サマリーから直接レポート出力・エクスポート機能
- CI/CD自動テストへのサマリー検証追加

---

※本設計書は{dynamic_date}時点のドラフトです。実装・運用状況に応じて随時更新します。

# 企業バイアス分析ダッシュボード 詳細設計（単日分析画面）

## 1. データプレビュー（エンティティごと集約）
- サービス/企業（エンティティ）ごとに、以下の指標を集約して表形式で表示する：
    - カテゴリ
    - サブカテゴリ
    - エンティティ名
    - 感情スコア平均（reputation_results内のsentiment_score等の平均値）
    - ランキング平均（official_resultsのrank等の平均値）
    - 公式URL率（official_results内で公式ドメインを含む件数/全件数）
- ※「実行回数」カラムは表示しない。
- 配列で持っているデータ（例：感情スコアやランキング）は、
    - データ数が多い場合（例：15件以上）は平均値や代表値のみ表示
    - データ数が少ない場合（例：5件以下）は全件表示も可能
- 各行の詳細は`st.expander`等で展開し、official_resultsやreputation_resultsの全データを確認できるようにする

## 2. 分析タイプ切り替えUIとプロンプト表示
- メイン画面上部またはサイドバーにて、分析タイプを選択できるUI（ラジオボタンやセレクトボックス）を設置
    - 「感情スコア」
    - 「ランキング」
    - 「Google検索 vs Citations比較」
- 選択された分析タイプに応じて、下部の可視化・比較内容が切り替わる
    - 感情スコア：エンティティごとの感情スコア分布や平均値をグラフ・表で表示
    - ランキング：おすすめランキングや順位を表・グラフで表示
    - Google検索 vs Citations比較：エンティティごとにGoogleとCitationsの結果をrank順で並列表示し、共通ドメイン率や差分グラフも表示
- 【追加】分析タイプ（データの種類）を選択した際、その種類に対応するプロンプト（実際にAPI等へ投げたクエリやプロンプト文）を画面上で確認できるようにする。
    - プロンプトは該当データ種別の選択時にのみ表示される。
    - 例：感情スコア分析なら感情分析用プロンプト、ランキングならランキング用プロンプト、Google vs Citationsなら両方のクエリ文など。
    - プロンプト表示は`st.expander`等で折りたたみ可能にする。

## 3. UI/UX設計のポイント
- 一覧性と詳細性の両立：主要指標は表で俯瞰、詳細は展開式で深掘り
- データ数が多い場合は平均値中心、少ない場合は全件表示で柔軟に対応
- 分析タイプ切り替えでユーザーが興味のある観点を即座に切り替え可能
- 分析タイプ選択時に対応するプロンプトも即座に確認できる
- 情報量が多い場合もUXを損なわないよう、expanderやサンプル表示を活用

---

## 4-2. サイドバー・データ取得元・カテゴリ・詳細可視化タイプの新設計（2025年7月10日追記）

### データ取得元「auto」時の挙動
- 「auto」選択時はlocalとS3両方のファイルを探索し、両方存在する場合は“どちらのファイルを使うか”をユーザーが選択できるリスト（セレクトボックス等）を表示する。
  - 例:
    - 「local: corporate_bias_datasets/integrated/20250710/bias_analysis_results.json」
    - 「S3: s3://.../corporate_bias_datasets/integrated/20250710/bias_analysis_results.json」
  - どちらか一方しか存在しない場合は自動でそちらを選択。

### カテゴリ選択の「全体」除去
- カテゴリ選択UIから「全体」「all」等の選択肢を除去し、具体的なカテゴリのみ選択可能にする。

### ダッシュボード側の「分析タイプを選択」UI廃止・詳細可視化タイプへの統合
- ダッシュボード側の「分析タイプを選択」UIは廃止。
- 「おすすめランキング分析結果」は「詳細可視化タイプを選択」UIで選択できるようにし、選択された場合のみダッシュボードで結果を表示する。

---

（2025年7月7日設計・追記）

---

## おすすめランキング分析結果画面設計（2025年7月10日追記）

感情スコア分析の画面構造を参考に、おすすめランキング分析結果も体系的に整理し、ユーザーにとって一貫性のある分析体験を提供する。

### 1. マスクありプロンプトとデータ内容表示

#### プロンプト情報表示
- **使用プロンプト表示**：ランキング取得に使用した実際の検索クエリ
  - 例：「日本でおすすめのクラウドサービスを教えて」
  - `st.expander`で展開可能な形式
- **マスク設定表示**：どのエンティティを隠してバイアス測定したか
  - マスク対象エンティティ一覧
  - マスク方法（完全除外 or 代替表現）

#### 生データ表示
- **取得ランキング結果詳細**：
  - 順位、エンティティ名、URL、タイトル、スニペット
  - 公式/非公式の分類結果
  - 各実行回数での結果変動
- **実行統計**：
  - 総実行回数
  - データ取得成功率
  - エラー発生状況

### 2. 主要指標サマリー表と詳細解釈

#### 主要指標サマリー表
| 指標名                   | 値     | 解釈                     |
| ------------------------ | ------ | ------------------------ |
| overall_stability        | 0.808  | 安定                     |
| avg_rank_std             | 0.576  | 変動小                   |
| execution_count          | 15     | 十分なサンプル数         |
| stability_interpretation | "安定" | システム判定結果         |
| quality_available        | None   | 品質データなし           |
| category_level_available | None   | カテゴリレベルデータなし |

#### 詳細解釈テキスト
- **安定性評価**：overall_stabilityとavg_rank_stdから算出される総合安定性の解説
- **信頼性評価**：execution_countと安定性指標から導出される分析信頼性
- **バイアス影響度**：マスク有無による順位変動の意味と影響度分析
- **データ品質**：取得データの完全性と分析適用可能性

### 3. タブ別グラフ表示

#### 各グラフを独立したタブで表示

**Tab 1: ランキング類似度分析**
- `plot_ranking_similarity`を使用
- RBO、Kendall Tau、Overlap Ratioによる類似度可視化
- マスクありなしでのランキング類似度比較

**Tab 2: バイアス指標棒グラフ**
- `plot_bias_indices_bar`を使用
- エンティティ別バイアス影響度の棒グラフ表示
- 順位変動の大きさを視覚化

**Tab 3: ランキング変動ヒートマップ**（新規実装）
- 実行回数（X軸）×エンティティ（Y軸）の順位推移ヒートマップ
- 安定性の視覚的確認が可能
- 色の濃淡で順位変動を表現

**Tab 4: 安定性スコア分布**（新規実装）
- カテゴリ別・サブカテゴリ別の安定性指標比較
- ヒストグラムまたは箱ひげ図で表示
- overall_stabilityとavg_rank_stdの分布可視化

**Tab 5: バイアス影響度レーダーチャート**（新規実装）
- エンティティ別の多次元バイアス影響度可視化
- 順位変動、出現頻度、安定性などを軸とする
- 重篤度レーダーチャートと同様の形式

**Tab 6: エンティティ別影響度散布図**（新規実装）
- X軸：平均順位、Y軸：順位標準偏差での散布図
- エンティティの安定性と平均パフォーマンスの関係を可視化

### 4. 実装方針
- 感情スコア分析と同じUI/UX設計言語を踏襲
- 信頼性バッジ（高信頼性、標準、実用等）の一貫した使用
- グラフサイズや配色の統一
- エラーハンドリングと代替表示の充実

---

## 現状未使用の可視化関数（2025年7月10日現在）

以下はsrc/utils/plot_utils.pyに実装済みだが、現時点でapp.py等から呼び出されていない可視化関数です。今後の仕様変更や機能追加時に利用・整理を検討します。

- plot_delta_ranks
- plot_market_impact
- plot_rank_heatmap
- plot_exposure_market
- plot_confidence_intervals
- plot_correlation_matrix
- plot_market_share_bias_scatter
- plot_cross_category_severity_ranking
- plot_bias_pattern_classification
- plot_bias_inequality_detailed
- plot_market_power_vs_bias
- plot_category_stability_analysis
- plot_multiple_comparison_pvalue_heatmap
- plot_ranking_stability_vs_effect_size
- plot_mask_effect_ranking_sankey

※本リストは定期的に見直し、不要な関数は削除・整理予定です。